<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>G&J Schools - System Diagnostic</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
            text-align: center;
        }

        .header h1 {
            color: #4361ee;
            margin-bottom: 10px;
            font-size: 32px;
        }

        .header p {
            color: #666;
            font-size: 16px;
        }

        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .test-section {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .test-section h2 {
            color: #333;
            margin-bottom: 15px;
            font-size: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .test-section h2 .icon {
            font-size: 24px;
        }

        .status {
            padding: 10px 15px;
            border-radius: 6px;
            font-weight: 600;
            display: inline-block;
            margin: 8px 0;
            font-size: 14px;
        }

        .success {
            background: #d4edda;
            color: #155724;
            border-left: 4px solid #28a745;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            border-left: 4px solid #dc3545;
        }

        .warning {
            background: #fff3cd;
            color: #856404;
            border-left: 4px solid #ffc107;
        }

        .info {
            background: #d1ecf1;
            color: #0c5460;
            border-left: 4px solid #17a2b8;
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            margin: 5px 5px 5px 0;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        button:active {
            transform: translateY(0);
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        }

        .btn-danger {
            background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%);
        }

        pre {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            overflow-x: auto;
            max-height: 400px;
            font-size: 13px;
            border: 1px solid #dee2e6;
            margin-top: 10px;
        }

        .results {
            margin-top: 15px;
        }

        input {
            padding: 10px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            width: 100%;
            margin: 5px 0;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        input:focus {
            outline: none;
            border-color: #667eea;
        }

        .input-group {
            margin-bottom: 15px;
        }

        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .summary-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .summary-box h3 {
            margin-bottom: 15px;
            font-size: 22px;
        }

        .summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .stat {
            background: rgba(255,255,255,0.2);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-value {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 14px;
            opacity: 0.9;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 15px;
        }

        .quick-fix {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            border-radius: 6px;
            margin-top: 15px;
        }

        .quick-fix h4 {
            color: #856404;
            margin-bottom: 10px;
        }

        .quick-fix code {
            background: #f8f9fa;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
        }

        @media (max-width: 768px) {
            .test-grid {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 24px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîç G & J Schools - System Diagnostic Tool</h1>
            <p>Complete system health check and troubleshooting</p>
        </div>

        <div class="summary-box" id="summaryBox" style="display: none;">
            <h3>üìä System Status Summary</h3>
            <div class="summary-stats">
                <div class="stat">
                    <div class="stat-value" id="serverStatus">‚ùì</div>
                    <div class="stat-label">Server</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="authStatus">‚ùì</div>
                    <div class="stat-label">Authentication</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="studentCount">0</div>
                    <div class="stat-label">Students</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="feeCount">0</div>
                    <div class="stat-label">Fee Records</div>
                </div>
            </div>
        </div>

        <div class="test-grid">
            <div class="test-section">
                <h2><span class="icon">üåê</span> Server Connection</h2>
                <p style="color: #666; margin-bottom: 15px; font-size: 14px;">
                    Tests if the backend server is running and responding
                </p>
                <button onclick="testServerConnection()" id="serverBtn">
                    Test Server Connection
                </button>
                <div id="serverResult" class="results"></div>
            </div>

            <div class="test-section">
                <h2><span class="icon">üîê</span> Authentication Test</h2>
                <p style="color: #666; margin-bottom: 15px; font-size: 14px;">
                    Tests login functionality with credentials
                </p>
                <div class="input-group">
                    <input type="email" id="loginEmail" placeholder="Email Address" value="admin@gjschools.com">
                </div>
                <div class="input-group">
                    <input type="password" id="loginPassword" placeholder="Password" value="admin123">
                </div>
                <div class="action-buttons">
                    <button onclick="testLogin()" id="loginBtn">Test Login</button>
                    <button onclick="clearAuth()" class="btn-danger">Clear Auth</button>
                </div>
                <div id="loginResult" class="results"></div>
            </div>

            <div class="test-section">
                <h2><span class="icon">üì°</span> API Endpoints</h2>
                <p style="color: #666; margin-bottom: 15px; font-size: 14px;">
                    Tests all major API endpoints
                </p>
                <button onclick="testAllEndpoints()" id="apiBtn">Test All APIs</button>
                <div id="apiResult" class="results"></div>
            </div>

            <div class="test-section">
                <h2><span class="icon">üíæ</span> Database Content</h2>
                <p style="color: #666; margin-bottom: 15px; font-size: 14px;">
                    Checks if database has seeded data
                </p>
                <button onclick="testDatabaseData()" id="dbBtn">Check Database</button>
                <div id="dbResult" class="results"></div>
            </div>

            <div class="test-section">
                <h2><span class="icon">üìä</span> Dashboard Data</h2>
                <p style="color: #666; margin-bottom: 15px; font-size: 14px;">
                    Simulates dashboard data loading
                </p>
                <button onclick="testDashboardLoad()" id="dashBtn">Test Dashboard</button>
                <div id="dashResult" class="results"></div>
            </div>

            <div class="test-section">
                <h2><span class="icon">üîß</span> Quick Actions</h2>
                <p style="color: #666; margin-bottom: 15px; font-size: 14px;">
                    Common troubleshooting actions
                </p>
                <div class="action-buttons">
                    <button onclick="runAllTests()" class="btn-success">Run All Tests</button>
                    <button onclick="exportResults()">Export Results</button>
                    <button onclick="goToDashboard()">Go to Dashboard</button>
                </div>
            </div>
        </div>

        <div class="test-section">
            <h2><span class="icon">üí°</span> Troubleshooting Guide</h2>
            
            <div class="quick-fix">
                <h4>‚ùå If Server Test Fails:</h4>
                <p>Make sure the server is running:</p>
                <code>npm run dev</code>
            </div>

            <div class="quick-fix">
                <h4>‚ùå If Database is Empty:</h4>
                <p>Run the seed script to populate data:</p>
                <code>npm run seed</code>
            </div>

            <div class="quick-fix">
                <h4>‚ùå If Login Fails:</h4>
                <p>Check PostgreSQL is running and credentials in .env file</p>
            </div>

            <div class="quick-fix">
                <h4>‚ùå If Dashboard is Empty:</h4>
                <p>1. Run all tests above<br>
                2. Check browser console (F12)<br>
                3. Verify API calls return data<br>
                4. Clear browser cache and refresh</p>
            </div>
        </div>
    </div>

    <script>
        let authToken = null;
        let testResults = {};
        const API_BASE = window.location.origin;

        function displayResult(elementId, status, message, data = null) {
            const element = document.getElementById(elementId);
            let html = `<div class="status ${status}">${message}</div>`;
            if (data) {
                html += `<pre>${JSON.stringify(data, null, 2)}</pre>`;
            }
            element.innerHTML = html;
            
            testResults[elementId] = { status, message, data };
            updateSummary();
        }

        function setButtonLoading(buttonId, loading) {
            const button = document.getElementById(buttonId);
            if (loading) {
                button.disabled = true;
                button.innerHTML = '<span class="loading"></span> Testing...';
            } else {
                button.disabled = false;
                button.textContent = button.textContent.replace('Testing...', 'Test Complete');
            }
        }

        function updateSummary() {
            const summaryBox = document.getElementById('summaryBox');
            summaryBox.style.display = 'block';

            // Update server status
            if (testResults.serverResult) {
                document.getElementById('serverStatus').textContent = 
                    testResults.serverResult.status === 'success' ? '‚úÖ' : '‚ùå';
            }

            // Update auth status
            if (testResults.loginResult) {
                document.getElementById('authStatus').textContent = 
                    testResults.loginResult.status === 'success' ? '‚úÖ' : '‚ùå';
            }

            // Update counts from database test
            if (testResults.dbResult && testResults.dbResult.data) {
                const data = testResults.dbResult.data;
                document.getElementById('studentCount').textContent = 
                    data.students?.count || 0;
                document.getElementById('feeCount').textContent = 
                    data.fees?.count || 0;
            }
        }

        async function testServerConnection() {
            setButtonLoading('serverBtn', true);
            try {
                const response = await fetch(`${API_BASE}/health`);
                const data = await response.json();
                
                if (response.ok) {
                    displayResult('serverResult', 'success', 
                        '‚úÖ Server is running and responding!', data);
                } else {
                    displayResult('serverResult', 'error', 
                        '‚ùå Server responded with error', data);
                }
            } catch (error) {
                displayResult('serverResult', 'error', 
                    '‚ùå Cannot connect to server. Is it running?', 
                    { error: error.message, suggestion: 'Run: npm run dev' });
            } finally {
                setButtonLoading('serverBtn', false);
            }
        }

        async function testLogin() {
            setButtonLoading('loginBtn', true);
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            if (!email || !password) {
                displayResult('loginResult', 'warning', 
                    '‚ö†Ô∏è Please enter both email and password');
                setButtonLoading('loginBtn', false);
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password, role: 'admin' })
                });

                const data = await response.json();
                
                if (data.success && data.token) {
                    authToken = data.token;
                    localStorage.setItem('edumanage_token', data.token);
                    localStorage.setItem('edumanage_user', JSON.stringify(data.user));
                    
                    displayResult('loginResult', 'success', 
                        '‚úÖ Login successful! Token saved.', { 
                            user: data.user,
                            tokenPreview: data.token.substring(0, 30) + '...'
                        });
                } else {
                    displayResult('loginResult', 'error', 
                        '‚ùå Login failed!', data);
                }
            } catch (error) {
                displayResult('loginResult', 'error', 
                    '‚ùå Login request failed!', { error: error.message });
            } finally {
                setButtonLoading('loginBtn', false);
            }
        }

        async function testAllEndpoints() {
            if (!authToken) {
                displayResult('apiResult', 'warning', 
                    '‚ö†Ô∏è Please login first to test APIs!');
                return;
            }

            setButtonLoading('apiBtn', true);

            const endpoints = [
                { name: 'Students', url: '/api/students' },
                { name: 'Fees', url: '/api/fees' },
                { name: 'Teachers', url: '/api/teachers' },
                { name: 'Grades', url: '/api/grades' }
            ];

            let results = [];
            let allSuccess = true;

            for (const endpoint of endpoints) {
                try {
                    const response = await fetch(`${API_BASE}${endpoint.url}`, {
                        headers: { 
                            'Authorization': `Bearer ${authToken}`,
                            'Content-Type': 'application/json'
                        }
                    });

                    const data = await response.json();
                    const success = response.ok && Array.isArray(data);
                    
                    if (!success) allSuccess = false;

                    results.push({
                        endpoint: endpoint.name,
                        status: success ? '‚úÖ' : '‚ùå',
                        statusCode: response.status,
                        recordCount: Array.isArray(data) ? data.length : 'N/A',
                        sample: Array.isArray(data) && data.length > 0 ? data[0] : null
                    });
                } catch (error) {
                    allSuccess = false;
                    results.push({
                        endpoint: endpoint.name,
                        status: '‚ùå',
                        error: error.message
                    });
                }
            }

            displayResult('apiResult', 
                allSuccess ? 'success' : 'warning',
                allSuccess ? '‚úÖ All API endpoints working!' : '‚ö†Ô∏è Some endpoints have issues',
                results
            );

            setButtonLoading('apiBtn', false);
        }

        async function testDatabaseData() {
            if (!authToken) {
                displayResult('dbResult', 'warning', 
                    '‚ö†Ô∏è Please login first!');
                return;
            }

            setButtonLoading('dbBtn', true);

            try {
                const [students, fees, teachers] = await Promise.all([
                    fetch(`${API_BASE}/api/students`, {
                        headers: { 'Authorization': `Bearer ${authToken}` }
                    }).then(r => r.json()),
                    fetch(`${API_BASE}/api/fees`, {
                        headers: { 'Authorization': `Bearer ${authToken}` }
                    }).then(r => r.json()),
                    fetch(`${API_BASE}/api/teachers`, {
                        headers: { 'Authorization': `Bearer ${authToken}` }
                    }).then(r => r.json())
                ]);

                const totalFees = Array.isArray(fees) ? 
                    fees.reduce((sum, f) => sum + (f.total_paid || 0), 0) : 0;

                const hasData = students.length > 0 || fees.length > 0 || teachers.length > 0;

                const summary = {
                    students: {
                        count: Array.isArray(students) ? students.length : 0,
                        sample: students[0] || null
                    },
                    fees: {
                        count: Array.isArray(fees) ? fees.length : 0,
                        totalCollected: `GHS ${totalFees.toFixed(2)}`,
                        sample: fees[0] || null
                    },
                    teachers: {
                        count: Array.isArray(teachers) ? teachers.length : 0,
                        sample: teachers[0] || null
                    }
                };

                displayResult('dbResult', 
                    hasData ? 'success' : 'warning',
                    hasData ? 
                        '‚úÖ Database has data!' : 
                        '‚ö†Ô∏è Database is empty! Run: npm run seed',
                    summary
                );
            } catch (error) {
                displayResult('dbResult', 'error', 
                    '‚ùå Database test failed!', { error: error.message });
            } finally {
                setButtonLoading('dbBtn', false);
            }
        }

        async function testDashboardLoad() {
            if (!authToken) {
                displayResult('dashResult', 'warning', 
                    '‚ö†Ô∏è Please login first!');
                return;
            }

            setButtonLoading('dashBtn', true);

            try {
                const startTime = performance.now();

                const [students, fees] = await Promise.all([
                    fetch(`${API_BASE}/api/students`, {
                        headers: { 'Authorization': `Bearer ${authToken}` }
                    }).then(r => r.json()),
                    fetch(`${API_BASE}/api/fees`, {
                        headers: { 'Authorization': `Bearer ${authToken}` }
                    }).then(r => r.json())
                ]);

                const loadTime = (performance.now() - startTime).toFixed(2);

                const totalCollected = Array.isArray(fees) ?
                    fees.reduce((sum, f) => sum + (f.total_paid || 0), 0) : 0;

                const dashboardData = {
                    loadTime: `${loadTime}ms`,
                    students: {
                        total: Array.isArray(students) ? students.length : 0,
                        active: Array.isArray(students) ? 
                            students.filter(s => s.status === 'Active').length : 0
                    },
                    fees: {
                        total: Array.isArray(fees) ? fees.length : 0,
                        collected: `GHS ${totalCollected.toFixed(2)}`,
                        paid: Array.isArray(fees) ? 
                            fees.filter(f => f.status === 'paid').length : 0,
                        pending: Array.isArray(fees) ? 
                            fees.filter(f => f.status === 'pending').length : 0
                    }
                };

                const hasData = dashboardData.students.total > 0;

                displayResult('dashResult',
                    hasData ? 'success' : 'warning',
                    hasData ?
                        `‚úÖ Dashboard would load successfully in ${loadTime}ms` :
                        '‚ö†Ô∏è Dashboard would be empty - no data found!',
                    dashboardData
                );
            } catch (error) {
                displayResult('dashResult', 'error',
                    '‚ùå Dashboard load test failed!', { error: error.message });
            } finally {
                setButtonLoading('dashBtn', false);
            }
        }

        async function runAllTests() {
            await testServerConnection();
            await new Promise(resolve => setTimeout(resolve, 500));
            await testLogin();
            await new Promise(resolve => setTimeout(resolve, 500));
            await testAllEndpoints();
            await new Promise(resolve => setTimeout(resolve, 500));
            await testDatabaseData();
            await new Promise(resolve => setTimeout(resolve, 500));
            await testDashboardLoad();
        }

        function clearAuth() {
            authToken = null;
            localStorage.removeItem('edumanage_token');
            localStorage.removeItem('edumanage_user');
            displayResult('loginResult', 'info', 
                '‚ÑπÔ∏è Authentication cleared. Login again to test.');
        }

        function exportResults() {
            const results = JSON.stringify(testResults, null, 2);
            const blob = new Blob([results], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `diagnostic-results-${Date.now()}.json`;
            a.click();
        }

        function goToDashboard() {
            window.location.href = '/';
        }

        // Auto-run server test on load
        window.onload = () => {
            console.log('üîç Diagnostic tool loaded');
            setTimeout(testServerConnection, 500);
        };
    </script>
</body>
</html>